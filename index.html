<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#111827">
  <title>Orange Beacon â€“ GST & Tax Tracker</title>
  <style>
    :root{--bg:#0b1220;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;--accent:#fb923c;--ok:#10b981;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font:15px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--ink);background:var(--bg)}
    .wrap{max-width:600px;margin:0 auto;padding:0 12px calc(20px + env(safe-area-inset-bottom));}
    header{position:sticky;top:0;background:rgba(11,18,32,.92);backdrop-filter:blur(8px);z-index:10;box-shadow:0 8px 18px rgba(0,0,0,.35);}
    .head-pad{height:calc(env(safe-area-inset-top) + 8px);} /* safe area for Dynamic Island */
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 12px}
    h1{margin:0;font-size:18px;flex:1;text-align:center}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;background:var(--accent);color:#111;font-weight:600;font-size:14px;cursor:pointer;white-space:nowrap}
    .btn.secondary{background:#1f2937;color:#e5e7eb}
    .grid{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:12px}
    label{display:block;font-size:13px;color:var(--muted);margin:6px 0 2px}
    input[type="text"],input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--ink);font-size:15px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .jobs{display:flex;flex-direction:column;gap:8px;max-height:55vh;overflow:auto}
    .job{display:flex;flex-direction:column;gap:6px;border:1px solid #273245;border-radius:12px;padding:10px;background:#0e1627}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:11px;padding:4px 6px;border-radius:999px;background:#1f2937;color:#muted}
    .tag.ok{background:rgba(16,185,129,.12);color:#a7f3d0}
    .tag.warn{background:rgba(251,146,60,.12);color:#fdba74}
    .money{font-variant-numeric:tabular-nums;font-size:15px;font-weight:600}
    .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
    .totals{display:flex;flex-direction:column;gap:8px}
    .pill{padding:10px;border-radius:10px;background:#0e1627;border:1px solid #273245;text-align:center}
    .pill strong{display:block;font-size:14px}
    .notice{padding:8px;border-radius:10px;background:#1f2937;border:1px dashed #334155;color:#fde68a;font-size:13px}
    .footer{margin:12px auto 0;font-size:12px;color:#9ca3af;text-align:center;max-width:600px;padding:0 12px}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:10px 16px;border-radius:12px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .3s ease;z-index:99}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <div class="head-pad"></div>
    <div class="wrap">
      <div class="bar">
        <button class="btn" id="backupBtn">Backup</button>
        <h1>GST & Tax Tracker</h1>
        <button class="btn secondary" id="importBtn">Restore</button>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card">
      <label>Job</label>
      <input id="jobName" type="text" placeholder="e.g. CCTV install">
      <label>Amount (incl GST)</label>
      <input id="jobAmount" inputmode="decimal" type="number" step="0.01" placeholder="0.00">
      <div class="row">
        <label><input id="paid" type="checkbox"> Paid</label>
        <label><input id="setAside" type="checkbox"> GST & Tax Set Aside</label>
      </div>
      <div class="row">
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn secondary" id="clearAllBtn">Clear All</button>
      </div>
      <div id="warn" class="notice" style="display:none"></div>
    </section>

    <section class="card">
      <div class="totals">
        <div class="pill"><span>Total</span><strong id="tGross">$0.00</strong></div>
        <div class="pill"><span>GST</span><strong id="tGST">$0.00</strong></div>
        <div class="pill"><span>Tax 30%</span><strong id="tTax">$0.00</strong></div>
      </div>
    </section>

    <section class="card">
      <input id="search" type="text" placeholder="Search jobsâ€¦">
      <div class="jobs" id="jobList"></div>
    </section>
  </main>

  <div class="footer">v3 Mobile Layout â€” sticky header, Dynamicâ€‘Island safe</div>
  <div class="toast" id="toast"></div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const toast=$('toast');
  const showToast=msg=>{ if(!toast) return; toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),2000); };
  const STORE_KEY='obst_jobs_v3';
  const money=n=>new Intl.NumberFormat('en-AU',{style:'currency',currency:'AUD'}).format(n||0);
  const gstPart=g=>+(g/11).toFixed(2);
  const netPart=g=>+(g-gstPart(g)).toFixed(2);
  const taxPart=g=>+((netPart(g))*0.30).toFixed(2);

  let storeOK=true;
  const safeStorage={get(){try{return JSON.parse(localStorage.getItem(STORE_KEY)||'[]')}catch(e){storeOK=false;return[]}},set(v){try{localStorage.setItem(STORE_KEY,JSON.stringify(v))}catch(e){storeOK=false}}};
  let jobs=safeStorage.get();

  function escapeHTML(s){return(s+"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

  function render(list=jobs){
    const g=list.reduce((a,j)=>a+(j.amount||0),0);
    const GST=list.reduce((a,j)=>a+gstPart(j.amount||0),0);
    const TAX=list.reduce((a,j)=>a+(j.paid?taxPart(j.amount||0):0),0);
    $('tGross').textContent=money(g);
    $('tGST').textContent=money(GST);
    $('tTax').textContent=money(TAX);

    const box=$('jobList'); box.innerHTML='';
    list.forEach((j,idx)=>{
      const el=document.createElement('div'); el.className='job';
      el.innerHTML=`
        <div class="row" style="justify-content:space-between">
          <div style="flex:1">
            <div style="font-weight:600">${escapeHTML(j.name||'Untitled')}</div>
            <div class="tags">
              <span class="tag">Net ${money(netPart(j.amount))}</span>
              <span class="tag">GST ${money(gstPart(j.amount))}</span>
              <span class="tag warn">Tax@30% ${money(taxPart(j.amount))}</span>
              ${j.paid?'<span class="tag ok">Paid</span>':''}
              ${j.setAside?'<span class="tag ok">Set Aside</span>':''}
            </div>
          </div>
          <div class="money">${money(j.amount)}</div>
        </div>
        <div class="actions">
          <button class="btn secondary" data-act="togglePaid" data-i="${idx}">${j.paid?'Unpay':'Mark Paid'}</button>
          <button class="btn secondary" data-act="toggleAside" data-i="${idx}">${j.setAside?'Unset Aside':'Set Aside'}</button>
          <button class="btn" data-act="del" data-i="${idx}">Delete</button>
        </div>`;
      box.appendChild(el);
    });

    const w=$('warn'); if(w) w.style.display = storeOK ? 'none' : 'block';
    if(w && !storeOK) w.textContent = 'Storage issue detected (iOS). Data is only in memory.';
  }

  function persist(){ if(storeOK) safeStorage.set(jobs); }

  function addJob(){
    const name=$('jobName').value.trim();
    const amount=+($('jobAmount').value||0);
    const paid=$('paid').checked;
    const setAside=$('setAside').checked;
    if(!name||!amount){ showToast('Enter job name and amount'); return; }
    jobs.unshift({name,amount,paid,setAside,ts:Date.now()});
    $('jobName').value=''; $('jobAmount').value=''; $('paid').checked=false; $('setAside').checked=false;
    persist(); render(); showToast('âœ… Job saved');
  }

  function handleList(e){
    const btn=e.target.closest('button'); if(!btn) return;
    const i=+btn.dataset.i; const act=btn.dataset.act; const j=jobs[i]; if(j==null) return;
    if(act==='del'){ if(confirm('Delete this job?')){ jobs.splice(i,1); persist(); render(); showToast('ðŸ—‘ï¸ Deleted'); } return; }
    if(act==='togglePaid'){ j.paid=!j.paid; persist(); render(); showToast(j.paid?'ðŸ’° Marked Paid':'âŒ Unpaid'); return; }
    if(act==='toggleAside'){ j.setAside=!j.setAside; persist(); render(); showToast(j.setAside?'âœ… Set Aside':'âŒ Unset'); return; }
  }

  async function doBackup(){
    const data=JSON.stringify(jobs,null,2);
    const blob=new Blob([data],{type:'application/json'});
    const filename='orange-beacon-gst-tracker-backup.json';
    try{
      if(navigator.share&&navigator.canShare){
        const file=new File([blob],filename,{type:'application/json'});
        if(navigator.canShare({files:[file]})){
          await navigator.share({files:[file],title:'GST & Tax Tracker backup'});
          showToast('ðŸ’¾ Backup shared');
          return;
        }
      }
    }catch(err){}
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename; a.target='_blank';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},2000);
    showToast('ðŸ’¾ Backup downloaded');
  }

  function doRestore(){
    const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
    inp.onchange=()=>{
      const f=inp.files&&inp.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{
        try{ const data=JSON.parse(r.result||'[]'); if(!Array.isArray(data)) throw new Error('Invalid file'); jobs=data; persist(); render(); showToast('ðŸ“¥ Restored'); }
        catch(e){ alert('Could not restore: '+e.message); }
      };
      r.readAsText(f);
    };
    inp.click();
  }

  // Bind events
  $('saveBtn').onclick=addJob;
  $('jobList').addEventListener('click',handleList);
  $('backupBtn').onclick=doBackup;
  $('importBtn').onclick=doRestore;
  $('clearAllBtn').onclick=()=>{ if(confirm('Clear ALL jobs?')){ jobs=[]; persist(); render(); showToast('ðŸ§¹ Cleared'); } };
  $('search').oninput=()=>{ const q=$('search').value.toLowerCase().trim(); if(!q) return render(); render(jobs.filter(j=>(j.name||'').toLowerCase().includes(q))); };

  // Also expose global fallbacks (in case event binding is blocked)
  window.app={ addJob, doBackup, doRestore, clearAll:()=>{ if(confirm('Clear ALL jobs?')){ jobs=[]; persist(); render(); showToast('ðŸ§¹ Cleared'); } } };

  render();
})();
</script>
</body>
</html>
