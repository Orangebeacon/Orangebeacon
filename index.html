<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#111827">
  <title>Orange Beacon ‚Äì GST & Tax Tracker</title>
  <style>
    :root{--bg:#0b1220;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;--accent:#fb923c;--ok:#10b981;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font:15px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--ink);background:var(--bg)}
    .wrap{max-width:600px;margin:0 auto;padding:env(safe-area-inset-top) 12px calc(20px + env(safe-area-inset-bottom));}
    header{position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter:blur(8px);z-index:3}
    .bar{display:flex;justify-content:center;padding:10px}
    h1{font-size:18px;margin:0;text-align:center;flex:1}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;background:var(--accent);color:#111;font-weight:600;font-size:14px;cursor:pointer}
    .grid{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:12px}
    label{display:block;font-size:13px;color:var(--muted);margin:6px 0 2px}
    input[type="text"],input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--ink);font-size:15px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .jobs{display:flex;flex-direction:column;gap:8px;max-height:55vh;overflow:auto}
    .job{display:flex;flex-direction:column;gap:6px;border:1px solid #273245;border-radius:12px;padding:10px;background:#0e1627}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:11px;padding:4px 6px;border-radius:999px;background:#1f2937;color:var(--muted)}
    .tag.ok{background:rgba(16,185,129,.12);color:#a7f3d0}
    .tag.warn{background:rgba(251,146,60,.12);color:#fdba74}
    .money{font-variant-numeric:tabular-nums;font-size:15px;font-weight:600}
    .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
    .totals{display:flex;flex-direction:column;gap:8px}
    .pill{padding:10px;border-radius:10px;background:#0e1627;border:1px solid #273245;text-align:center}
    .pill strong{display:block;font-size:14px}
    .notice{padding:8px;border-radius:10px;background:#1f2937;border:1px dashed #334155;color:#fde68a;font-size:13px}
    .footer{margin-top:12px;font-size:12px;color:var(--muted);text-align:center}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:10px 16px;border-radius:12px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .3s ease;z-index:99}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <div class="wrap bar">
      <button class="btn" id="backupBtn">Backup</button>
      <button class="btn" style="background:#1f2937;color:#e5e7eb" id="importBtn">Restore</button>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card">
      <label>Job</label>
      <input id="jobName" type="text" placeholder="e.g. CCTV install">
      <label>Amount (incl GST)</label>
      <input id="jobAmount" inputmode="decimal" type="number" step="0.01" placeholder="0.00">
      <div class="row">
        <label><input id="paid" type="checkbox"> Paid</label>
        <label><input id="setAside" type="checkbox"> GST & Tax Set Aside</label>
      </div>
      <div class="row">
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn" style="background:#1f2937;color:#e5e7eb" id="clearAllBtn">Clear All</button>
      </div>
      <div id="warn" class="notice" style="display:none"></div>
    </section>

    <section class="card">
      <div class="totals">
        <div class="pill"><span>Total</span><strong id="tGross">$0.00</strong></div>
        <div class="pill"><span>GST</span><strong id="tGST">$0.00</strong></div>
        <div class="pill"><span>Tax 30%</span><strong id="tTax">$0.00</strong></div>
      </div>
    </section>

    <section class="card">
      <input id="search" type="text" placeholder="Search jobs‚Ä¶">
      <div class="jobs" id="jobList"></div>
    </section>
  </main>

  <div class="wrap footer">v3 Mobile Layout</div>
  <div class="toast" id="toast"></div>

<script>
// Hardened script: defensive init + on-screen error reporting
(function(){
  function reportError(msg){
    try{ const t=document.getElementById('toast'); if(t){ t.textContent = '‚ö†Ô∏è '+msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); } }
    catch(_){ /* ignore */ }
    console.error(msg);
  }

  try {
    const STORE_KEY='obst_jobs_v3';
    const $=id=>document.getElementById(id);
    const toast=$('toast');
    const showToast=msg=>{ if(!toast) return; toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),2000); };
    const fmt=n=>new Intl.NumberFormat('en-AU',{style:'currency',currency:'AUD'}).format(n||0);
    const gstPart=g=>+(g/11).toFixed(2);
    const netPart=g=>+(g-gstPart(g)).toFixed(2);
    const taxPart=g=>+((netPart(g))*0.30).toFixed(2);

    let storeOK=true;
    const safeStorage={
      get(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); } catch(e){ storeOK=false; return []; } },
      set(v){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(v)); } catch(e){ storeOK=false; }
    };

    let jobs = safeStorage.get();

    function escapeHTML(s){ return (s+"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    function render(list=jobs){
      const g = list.reduce((a,j)=>a+(j.amount||0),0);
      const GST = list.reduce((a,j)=>a+gstPart(j.amount||0),0);
      const TAX = list.reduce((a,j)=>a+(j.paid?taxPart(j.amount||0):0),0);
      const tGross = $('tGross'), tGST = $('tGST'), tTax = $('tTax');
      if(tGross) tGross.textContent = fmt(g);
      if(tGST) tGST.textContent = fmt(GST);
      if(tTax) tTax.textContent = fmt(TAX);

      const box = $('jobList'); if(!box) return;
      box.innerHTML = '';
      list.forEach((j,idx)=>{
        const el = document.createElement('div'); el.className='job';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div style="flex:1">
              <div style="font-weight:600">${escapeHTML(j.name||'Untitled')}</div>
              <div class="tags">
                <span class="tag">Net ${fmt(netPart(j.amount))}</span>
                <span class="tag">GST ${fmt(gstPart(j.amount))}</span>
                <span class="tag warn">Tax@30% ${fmt(taxPart(j.amount))}</span>
                ${j.paid?'<span class="tag ok">Paid</span>':''}
                ${j.setAside?'<span class="tag ok">Set Aside</span>':''}
              </div>
            </div>
            <div class="money">${fmt(j.amount)}</div>
          </div>
          <div class="actions">
            <button class="btn" style="background:#374151;color:#e5e7eb" data-act="togglePaid" data-i="${idx}">${j.paid?'Unpay':'Mark Paid'}</button>
            <button class="btn" style="background:#374151;color:#e5e7eb" data-act="toggleAside" data-i="${idx}">${j.setAside?'Unset Aside':'Set Aside'}</button>
            <button class="btn" data-act="del" data-i="${idx}">Delete</button>
          </div>`;
        box.appendChild(el);
      });

      const w=$('warn'); if(w) w.style.display = storeOK ? 'none' : 'block';
      if(w && !storeOK) w.textContent = 'Storage issue detected (iOS). Data is only in memory.';
    }

    function persist(){ if(storeOK) safeStorage.set(jobs); }

    function addJob(){
      const nameEl=$('jobName'), amtEl=$('jobAmount');
      if(!nameEl || !amtEl) return;
      const name=(nameEl.value||'').trim();
      const amount=+(amtEl.value||0);
      const paid=$('paid')?.checked||false;
      const setAside=$('setAside')?.checked||false;
      if(!name || !amount){ reportError('Enter job name and amount'); return; }
      jobs.unshift({name, amount, paid, setAside, ts:Date.now()});
      nameEl.value=''; amtEl.value=''; if($('paid')) $('paid').checked=false; if($('setAside')) $('setAside').checked=false;
      persist(); render(); showToast('‚úÖ Job saved');
    }

    function handleList(e){
      const btn = e.target.closest('button'); if(!btn) return;
      const i = +btn.dataset.i; const act = btn.dataset.act; const j = jobs[i]; if(j==null) return;
      if(act==='del'){ if(confirm('Delete this job?')){ jobs.splice(i,1); persist(); render(); showToast('üóëÔ∏è Deleted'); } return; }
      if(act==='togglePaid'){ j.paid=!j.paid; persist(); render(); showToast(j.paid?'üí∞ Marked Paid':'‚Ü©Ô∏è Unpaid'); return; }
      if(act==='toggleAside'){ j.setAside=!j.setAside; persist(); render(); showToast(j.setAside?'‚úÖ Set Aside':'‚Ü©Ô∏è Unset'); return; }
    }

    async function doBackup(){
      const data = JSON.stringify(jobs,null,2);
      const blob = new Blob([data], {type:'application/json'});
      const filename = 'orange-beacon-gst-tracker-backup.json';
      try{
        if(navigator.share && navigator.canShare){
          const file = new File([blob], filename, {type:'application/json'});
          if(navigator.canShare({files:[file]})){
            await navigator.share({files:[file], title:'GST & Tax Tracker backup'});
            showToast('üíæ Backup shared');
            return;
          }
        }
      }catch(_){ /* fall through */ }
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.target='_blank';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2000);
      showToast('üíæ Backup downloaded');
    }

    function doRestore(){
      const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
      inp.onchange=()=>{
        const f=inp.files && inp.files[0]; if(!f) return;
        const r=new FileReader(); r.onload=()=>{
          try{
            const data=JSON.parse(r.result||'[]'); if(!Array.isArray(data)) throw new Error('Invalid file');
            jobs=data; persist(); render(); showToast('üì• Restored');
          }catch(e){ reportError('Could not restore: '+e.message); }
        };
        r.readAsText(f);
      };
      inp.click();
    }

    // Bind events only if elements exist
    const saveBtn=$('saveBtn'); if(saveBtn) saveBtn.onclick=addJob;
    const list=$('jobList'); if(list) list.addEventListener('click', handleList);
    const backupBtn=$('backupBtn'); if(backupBtn) backupBtn.onclick=doBackup;
    const importBtn=$('importBtn'); if(importBtn) importBtn.onclick=doRestore;
    const clearBtn=$('clearAllBtn'); if(clearBtn) clearBtn.onclick=()=>{ if(confirm('Clear ALL jobs?')){ jobs=[]; persist(); render(); showToast('üßπ Cleared'); } };
    const search=$('search'); if(search) search.oninput=()=>{ const q=search.value.toLowerCase().trim(); if(!q) return render(); render(jobs.filter(j=>(j.name||'').toLowerCase().includes(q))); };

    // First paint
    render();
  } catch (e) {
    reportError('Startup error: '+ (e && e.message ? e.message : e));
  }
})();
</script>
</body>
</html>
